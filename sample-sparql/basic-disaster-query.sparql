PREFIX geo: <http://www.opengis.net/ont/geosparql#>
PREFIX mlit: <http://example.org/mlit/ontology#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

# 基本的な災害対応クエリ - 人口と土地利用データの組み合わせ

SELECT ?meshId ?totalPopulation ?elderlyPopulation ?buildingArea ?forestArea ?priorityScore
WHERE {
  # メッシュデータの取得
  ?mesh rdf:type mlit:Mesh ;
        mlit:meshId ?meshId .
  
  # 人口データの取得
  OPTIONAL {
    ?mesh mlit:hasPopulationData ?popSnapshot .
    ?popSnapshot mlit:totalPopulation ?totalPop ;
                 mlit:ageCategory65Plus ?elderlyPop .
    BIND(COALESCE(?totalPop, 0) AS ?totalPopulation)
    BIND(COALESCE(?elderlyPop, 0) AS ?elderlyPopulation)
  }
  
  # 建物用地面積の取得
  OPTIONAL {
    ?mesh mlit:hasLandUseData ?buildingLand .
    ?buildingLand mlit:landUseCategory "建物用地" ;
                  mlit:landUseArea ?buildingAreaValue .
    BIND(?buildingAreaValue AS ?buildingArea)
  }
  
  # 森林面積の取得
  OPTIONAL {
    ?mesh mlit:hasLandUseData ?forestLand .
    ?forestLand mlit:landUseCategory "森林" ;
                mlit:landUseArea ?forestAreaValue .
    BIND(?forestAreaValue AS ?forestArea)
  }
  
  # 優先度スコア計算（簡易版）
  BIND(
    # 人口密度スコア（高齢者2倍重み付け）60%
    (COALESCE(?totalPopulation, 0) * 1.0 + COALESCE(?elderlyPopulation, 0) * 2.0) * 0.6 +
    
    # 建物用地面積スコア（被害想定）40%
    (COALESCE(?buildingArea, 0) / 1000000) * 0.4
    
    AS ?priorityScore
  )
  
  # 最低閾値フィルタ（優先度スコア > 10）
  FILTER(?priorityScore > 10)
}
ORDER BY DESC(?priorityScore)
LIMIT 10