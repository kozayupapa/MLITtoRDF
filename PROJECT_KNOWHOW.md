# プロジェクトノウハウ集: MLIT GeoJSON to RDF4J

このドキュメントは、国土交通省のGeoJSONデータをGeoSPARQLとしてRDF4Jに投入し、分析するためのノウハウをまとめたものです。

## 1. 基本アーキテクチャ

このプロジェクトは、以下の3つの主要なステップで構成されるNode.js/TypeScriptアプリケーションです。

1.  **Parse**: `data-parser.ts`
    *   GeoJSONファイルを読み込み、フィーチャー単位でパースします。
2.  **Transform**: `geo-transformer.ts`
    *   パースされたGeoJSONフィーチャーをGeoSPARQL準拠のRDFトリプルに変換します。
    *   **日本の測地系(JGD2011)から世界標準のWGS84への座標変換**がここで行われます。
3.  **Load**: `rdf-loader.ts`
    *   変換されたトリプルを、SPARQL 1.1 UPDATE (`INSERT DATA`) を使ってRDF4Jサーバーにバッチ投入します。

---

## 2. GeoSPARQLに関する重要な知見

### 2.1. WKTリテラルの格納方法 (最重要)

RDF4JのGeoSPARQL機能と完全な互換性を保つためには、WKT(Well-Known Text)ジオメトリを以下の形式で格納する必要があります。

- **述語 (Predicate)**: `geo:asWKT`
- **オブジェクト (Object)**: `"POLYGON(...)"^^geo:wktLiteral`

**誤った例:**
```turtle
# RDF4Jの空間インデックスが機能しない
?geometry geo:wktLiteral "POLYGON(...)"^^geo:wktLiteral .
```

**正しい例:**
```turtle
?geometry geo:asWKT "POLYGON(...)"^^geo:wktLiteral .
```

このプロジェクトでは、`geo-asWKT-migration-guide.md` に従って、すべてのデータ生成ロジックとSPARQLクエリを正しい形式に統一済みです。

### 2.2. SPARQLクエリの書き方

空間クエリを記述する際は、以下の点に注意してください。

- **空間関数**: `geof:sfIntersects` を使うのが基本です。
- **WKTリテラルの指定**: クエリ内でBBOXなどを指定する際は、CRS情報を含めないシンプルなWKTリテラルが最も安定します。

```sparql
# 安定して動作するFILTER句の例
FILTER(geof:sfIntersects(?wkt, "POLYGON((136.0 36.1, ...))"^^geo:wktLiteral))
```

詳細は `geosparql-troubleshooting.md` および `sample-sparql/bbox-query-corrected.sparql` を参照してください。

---

## 3. パフォーマンス最適化戦略

大規模な地理空間データを扱うため、パフォーマンスは非常に重要です。このプロジェクトでは以下の最適化が実装されています。

### 3.1. データ投入時のトリプル数削減

`geo-transformer.ts` にて、アプリケーションの目的に合わせて意図的にデータ量を削減しています。

- **人口データ**: `PTA` (14歳以下), `PTB` (15-64歳), `PTC` (65歳以上) のような主要な人口区分のみを格納し、詳細な年齢別データは省略。
- **土地利用データ**: 面積が5000平米未満の小さな土地利用データは無視。また、個別のIRIを生成せず、メッシュの直接のプロパティとして面積を格納することでトリプル数を80%以上削減。
- **洪水ハザードデータ**:
    - `minFloodDepthRank` オプションにより、ランクの低い（影響の小さい）浸水想定区域を除外。
    - `aggregateFloodZonesByRank` オプションを有効にすると、地理的に隣接し、かつハザード種別・ランクが同じポリゴンを一つの `MultiPolygon` に集約。これによりフィーチャー数を大幅に削減可能。

### 3.2. データ投入処理の堅牢化

`rdf-loader.ts` は、大量データ投入を安定して行うための以下の仕組みを備えています。

- **バッチ処理**: 指定されたサイズでトリプルを分割して投入。
- **リトライ機構**: ネットワークエラーなど一時的な問題が発生した場合、エクスポネンシャルバックオフ付きでリトライを実行。
- **再開支援**: バッチ処理が恒久的なエラーで失敗した場合、ログに「次にこのコマンドを実行してください」という形式で `--skipFeatures` パラメータ付きの再開コマンド例を出力します。

---

## 4. 高度な空間分析クエリ

### スライディングウィンドウ分析

特定のメッシュや行政区画に縛られず、広域を均一に分析する手法です。`sample_queries/sliding_window_10km_analysis.sparql` に実装例があります。

**コンセプト**:
1.  SPARQLの `VALUES` 句を使い、分析したい領域を覆う仮想的なグリッド（ウィンドウ）を動的に生成します。
2.  各ウィンドウポリゴンと `geof:sfIntersects` を使って、その範囲に含まれる人口メッシュやハザード区域を抽出します。
3.  ウィンドウごとに人口やハザード件数を `GROUP BY` で集計します。
4.  人口密度とハザードの深刻度を組み合わせてリスクスコアを算出し、高リスク地域を特定します。

この手法により、メッシュの境界を越えた地域レベルでのリスク評価が可能になります。
